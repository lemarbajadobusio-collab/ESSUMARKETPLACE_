<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESSU Marketplace | Sign In / Sign Up</title>
  <link rel="stylesheet" href="buyer.css?v=20260218c">
</head>
<body>
  <script>
    const LAST_PAGE_KEY = 'essu_last_page';
    localStorage.setItem(LAST_PAGE_KEY, 'index.html');
    const forceBuyerAuth = localStorage.getItem('essu_force_buyer_auth') === 'true';
    const navEntry = performance.getEntriesByType('navigation')[0];
    const isReload = navEntry?.type === 'reload';

    const isHosted = window.location.hostname.endsWith('github.io');
    let currentUser = null;
    try {
      currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    } catch {}

    if (isReload) {
      // Keep user on the current page after browser refresh.
    } else if (forceBuyerAuth) {
      // stay on buyer auth (login/signup) page
    } else if (currentUser?.role === 'admin') {
      window.location.href = 'admin.html';
    } else if (localStorage.getItem('buyer')) {
      window.location.href = 'buyer.html';
    } else if (localStorage.getItem('essu_current_user') || currentUser?.role === 'seller') {
      window.location.href = 'seller.html';
    } else if (!isHosted && localStorage.getItem('essu_preferred_role') === 'seller') {
      window.location.href = 'seller.html';
    }
  </script>

  <section class="auth">
    <div class="auth-header">
      <div class="auth-logo">
        <h1>ESSU MARKETPLACE</h1>
      </div>
      <p>Welcome back! Sign in to continue</p>
    </div>

    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" id="loginTab">Log in</button>
        <button class="auth-tab" id="signupTab">Sign up</button>
      </div>

      <!-- LOGIN (keeps original input ids for JS compatibility) -->
      <form id="loginForm" class="auth-form" onsubmit="event.preventDefault(); login();">
        <div class="input-group">
          <label for="name">Full name</label>
          <input id="name" type="text" placeholder="Enter name" required />
        </div>
        <div class="input-group">
          <label for="email">Gmail address</label>
          <input id="email" type="email" placeholder="wer@gmail.com" required />
        </div>
        <div class="input-group">
          <label for="password">Password</label>
          <div class="password-field">
            <input id="password" type="password" placeholder="Enter your password" required />
            <button type="button" class="toggle-password" data-target="password" aria-label="Show password">
              <svg viewBox="0 0 24 24" aria-hidden="true" style="fill:#475569;width:20px;height:20px">
                <path d="M12 5c5.05 0 9.27 3.11 11 7-1.73 3.89-5.95 7-11 7S2.73 15.89 1 12c1.73-3.89 5.95-7 11-7zm0 2C8.38 7 5.25 9.09 3.7 12 5.25 14.91 8.38 17 12 17s6.75-2.09 8.3-5C18.75 9.09 15.62 7 12 7zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/>
              </svg>
            </button>
          </div>
        </div>
        <button type="submit" class="primary-btn">Log in</button>
        <p class="signup-link">Don't have an account? <a href="#" id="signupLink">Sign Up</a></p>
        <p id="loginError"></p>
      </form>

      <!-- SIGNUP (keeps original input ids for JS compatibility) -->
      <form id="signupForm" class="auth-form" hidden onsubmit="event.preventDefault(); signup();">
        <div class="input-grid signup-grid">
          <div class="input-group">
            <label for="suName">Full Name</label>
            <input id="suName" type="text" placeholder="Your full name" required />
          </div>
          <div class="input-group">
            <label for="suEmail">Email Address</label>
            <input id="suEmail" type="email" placeholder="your.email@essu.edu.ph" required />
          </div>
          <div class="input-group full">
            <label for="suPassword">Password</label>
            <div class="password-field">
              <input id="suPassword" type="password" placeholder="Create password" required />
              <button type="button" class="toggle-password" data-target="suPassword" aria-label="Show password">
                <svg viewBox="0 0 24 24" aria-hidden="true" style="fill:#475569;width:20px;height:20px">
                  <path d="M12 5c5.05 0 9.27 3.11 11 7-1.73 3.89-5.95 7-11 7S2.73 15.89 1 12c1.73-3.89 5.95-7 11-7zm0 2C8.38 7 5.25 9.09 3.7 12 5.25 14.91 8.38 17 12 17s6.75-2.09 8.3-5C18.75 9.09 15.62 7 12 7zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="input-group full">
            <label for="suConfirm">Confirm Password</label>
            <div class="password-field">
              <input id="suConfirm" type="password" placeholder="Confirm password" required />
              <button type="button" class="toggle-password" data-target="suConfirm" aria-label="Show password">
                <svg viewBox="0 0 24 24" aria-hidden="true" style="fill:#475569;width:20px;height:20px">
                  <path d="M12 5c5.05 0 9.27 3.11 11 7-1.73 3.89-5.95 7-11 7S2.73 15.89 1 12c1.73-3.89 5.95-7 11-7zm0 2C8.38 7 5.25 9.09 3.7 12 5.25 14.91 8.38 17 12 17s6.75-2.09 8.3-5C18.75 9.09 15.62 7 12 7zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <button type="submit" class="primary-btn">Create Account</button>
        <p id="signupError"></p>
      </form>
    </div>
  </section>

  <script src="runtime-config.js?v=20260217a"></script>
  <script src="buyer.js?v=20260217k"></script>
  <script>
    const INDEX_AUTH_TAB_KEY = 'essu_index_auth_tab';

    function setIndexAuthTab(tab) {
      localStorage.setItem(INDEX_AUTH_TAB_KEY, tab);
      const isLogin = tab === 'login';
      document.getElementById('loginForm').hidden = !isLogin;
      document.getElementById('signupForm').hidden = isLogin;
      document.getElementById('loginTab').classList.toggle('active', isLogin);
      document.getElementById('signupTab').classList.toggle('active', !isLogin);
    }

    // Tab switching for login/signup
    document.getElementById('loginTab').addEventListener('click', (e) => {
      e.preventDefault();
      setIndexAuthTab('login');
    });
    
    document.getElementById('signupTab').addEventListener('click', (e) => {
      e.preventDefault();
      setIndexAuthTab('signup');
    });

    // Sign Up link in login form
    const signupLink = document.getElementById('signupLink');
    if (signupLink) {
      signupLink.addEventListener('click', (e) => {
        e.preventDefault();
        setIndexAuthTab('signup');
      });
    }

    // Password toggle
    document.querySelectorAll('.toggle-password').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('data-target');
        const input = document.getElementById(targetId);
        input.type = input.type === 'password' ? 'text' : 'password';
      });
    });

    setIndexAuthTab(localStorage.getItem(INDEX_AUTH_TAB_KEY) || 'login');
  </script>
</body>
</html>
