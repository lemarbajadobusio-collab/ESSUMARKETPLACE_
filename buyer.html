<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESSU Marketplace</title>
  <link rel="stylesheet" href="buyer.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Check authentication immediately -->
  <script>
  // Quick auth check before rendering
  if (!localStorage.getItem('buyer')) {
    window.location.href = "index.html";
  }
</script>

<!-- NAVBAR -->
<header class="navbar">
  <div class="nav-left">
    <svg viewBox="0 0 24 24" width="24" height="24" role="button" tabindex="0" title="Home" onclick="location.href='index.html'" onkeydown="if(event.key==='Enter') location.href='index.html'" style="fill:white;margin-right:8px;cursor:pointer">
      <path d="M4 6a2 2 0 0 1 2-2h9l5 5v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6zm12 0H6v12h12V9h-4V6z"/>
    </svg>
    <h1>ESSU MARKETPLACE</h1>
  </div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search products..." oninput="searchProducts(this.value)">
  </div>

  <div class="nav-right">
    <button onclick="openNotificationsPanel()" style="position:relative;background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.93 6 11v5l-2 2v1h16v-1l-2-2z"/>
      </svg>
      <span id="notifBadge" class="badge"></span>
    </button>
    <button onclick="openMessagesPanel()" style="position:relative;background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
      </svg>
      <span id="msgBadge" class="badge"></span>
    </button>
    <button onclick="toggleProfile()" style="background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </button>
    <button onclick="openMiniCart()" style="position:relative;background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
      </svg>
      <span id="cartBadge" class="badge"></span>
    </button>
  </div>
</header>

<!-- MAIN -->
<main class="container">

  <div class="title-row">
    <h2>Discover Items</h2>
  </div>

  <!-- CATEGORIES -->
  <div class="categories">
    <button class="cat active" onclick="setCategory('all')">All</button>
    <button class="cat" onclick="setCategory('electronics')">Electronics</button>
    <button class="cat" onclick="setCategory('books')">Books</button>
    <button class="cat" onclick="setCategory('clothing')">Clothing</button>
    <button class="cat" onclick="setCategory('furniture')">Furniture</button>
    <button class="cat" onclick="setCategory('sports')">Sports</button>
    <button class="cat" onclick="setCategory('food')">Food</button>
    <button class="cat" onclick="setCategory('other')">Other</button>
  </div>



  <!-- PRODUCTS GRID (populated by app.js) -->
  <div class="grid" id="itemsGrid"></div>

</main>

<!-- FOOTER -->
<footer class="footer">
  <p>&copy; 2023 ESSU Marketplace. All rights reserved.</p>
</footer>



<!-- MINI CART PANEL -->
<div id="miniCart" class="mini-cart">
  <div class="mini-cart-content">
    <button class="mini-close" onclick="closeMiniCart()">√ó</button>
    <h4>Your Cart</h4>
    <div id="miniCartList" style="margin-top:8px;max-height:420px;overflow:auto"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="muted">Total</div>
      <div id="miniCartTotal" style="font-weight:800;color:var(--accent)"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="closeMiniCart()" style="flex:1;background:#f3f3f3;border:none;padding:10px;border-radius:8px">Continue Shopping</button>
      <button onclick="placeOrderFromMini()" style="flex:1;background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px">Checkout</button>
    </div>
  </div>
</div>

<!-- CHECKOUT MODAL (inline stepper) -->
<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeCheckoutModal()">√ó</button>
    <h3>Checkout</h3>

    <div id="step-login" class="hidden">
      <p class="muted">Please log in or sign up to place orders.</p>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button onclick="location.href='index.html'" style="padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff">Login</button>
        <button onclick="location.href='buyersignin.html'" style="padding:8px 12px;border-radius:8px;border:1px solid #eee;background:#fff">Sign up</button>
      </div>
    </div>

    <div id="step-payment" class="hidden">
      <p class="muted">Step 1 ‚Äî Choose payment method</p>
      <div style="margin:12px 0">
        <label><input type="radio" name="pmethod" value="Cash on Delivery" checked> Cash on Delivery</label><br>
        <label style="color:#ccc;"><input type="radio" name="pmethod" value="GCash" disabled> GCash (Coming Soon)</label><br>
        <label style="color:#ccc;"><input type="radio" name="pmethod" value="PayMaya" disabled> PayMaya (Coming Soon)</label>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button onclick="closeCheckoutModal()" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Cancel</button>
        <button onclick="toAddressStep()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Continue</button>
      </div>
    </div>

    <div id="step-address" class="hidden">
      <p class="muted">Step 2 ‚Äî Delivery address</p>
      <div class="address-form">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="addressName" placeholder="e.g. Juan Dela Cruz" class="address-input">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="addressPhone" placeholder="e.g. +63 912 345 6789 or 09123456789" class="address-input">
        </div>
        <div class="form-group">
          <label>City / Municipality</label>
          <input type="text" id="addressCity" placeholder="e.g. City of Borongan" class="address-input">
        </div>
        <div class="form-group">
          <label>CAMPUS</label>
          <select id="addressCampus" class="address-input">
            <option value="">Select Campus</option>
            <option value="Essu Arteche">Essu Arteche</option>
            <option value="Essu Can-Avid">Essu Can-Avid</option>
            <option value="Essu Borongan">Essu Borongan</option>
            <option value="Essu Maydolong">Essu Maydolong</option>
            <option value="Essu Guiuan">Essu Guiuan</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Department (Inside ESSU)</label>
          <select id="addressDepartment" class="address-input">
            <option value="">Select Department</option>
            <option value="College of Engineering">College of Engineering</option>
            <option value="College of Education">College of Education</option>
            <option value="College of Arts and Sciences">College of Arts and Sciences</option>
            <option value="College of Business and Management">College of Business and Management</option>
            <option value="College of Nursing">College of Nursing</option>
            <option value="College of Agriculture">College of Agriculture</option>
            <option value="College of Information Technology">College of Information Technology</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Additional Instructions (Optional)</label>
          <textarea id="addressNotes" placeholder="e.g. Leave at the guard house, ring the bell twice" class="address-textarea"></textarea>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button onclick="document.getElementById('step-address').classList.add('hidden');document.getElementById('step-payment').classList.remove('hidden')" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Back</button>
        <button onclick="toReviewStep()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Continue</button>
      </div>
    </div>

    <div id="step-review" class="hidden">
      <p class="muted">Review & Confirm</p>
      <div id="checkoutItems" style="max-height:220px;overflow:auto;margin-bottom:10px"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="muted">Total</div>
        <div id="checkoutTotal" style="font-weight:800;color:var(--accent)"></div>
      </div>
      <div class="form-group">
        <label>Order Review (Optional)</label>
        <textarea id="orderReview" placeholder="Add any review or notes for your order..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;min-height:60px;"></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="document.getElementById('step-review').classList.add('hidden');document.getElementById('step-address').classList.remove('hidden')" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Back</button>
        <button onclick="confirmOrderFromModal()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Confirm Order</button>
      </div>
    </div>

  </div>
</div>



<!-- PROFILE SIDEBAR -->
<div id="profileSidebar" class="profile-sidebar">
  <button class="close-btn" onclick="toggleProfile()">√ó</button>
  <div class="profile-header">
    <div class="avatar"></div>
    <h3></h3>
    <p id="sidebarEmail"></p>
  </div>
  <button class="sidebar-btn" onclick="openEditProfileModal()">Edit Profile</button>
  <button class="sidebar-btn" onclick="openSellPanel()">Start Selling</button>
  <button class="sidebar-btn danger" onclick="logout()">Sign Out</button>
  <div class="orders">
    <h4>My Orders</h4>
    <p id="sidebarName">Name: </p>
    <div id="sidebarOrders"></div>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay" onclick="toggleProfile()"></div>

<script src="buyer.js"></script>

<!-- NOTIFICATIONS PANEL -->
<div id="notificationsPanel" class="notifications-panel">
  <div class="panel-content">
    <button class="panel-close" onclick="closeNotificationsPanel()">&larr;</button>
    <h3>üîî Notifications</h3>
    <div id="notificationsList" class="notifications-list"></div>
  </div>
</div>

<!-- MESSAGES PANEL -->
<div id="messagesPanel" class="messages-panel">
  <div class="panel-content">
    <button class="panel-close" onclick="closeMessagesPanel()">‚Üê</button>
    <h3>üí¨ Messages</h3>
    <div id="conversationsList" class="conversations-list"></div>
    <div id="chatView" class="chat-view hidden">
      <button onclick="backToConversations()">‚Üê Back</button>
      <h4 id="chatSellerName"></h4>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div id="editProfileModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeEditProfileModal()">√ó</button>
    <h3>Edit Profile</h3>
    <form id="editProfileForm">
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="editName" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="editEmail" placeholder="Enter your email" readonly>
      </div>
      <div class="form-group">
        <label>Change Profile Photo</label>
        <input type="file" id="editPhoto" accept="image/*" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
      </div>
      <div class="form-group">
        <label>New Password (leave blank to keep current)</label>
        <input type="password" id="editPassword" placeholder="Enter new password">
      </div>
      <div class="form-group">
        <label>Confirm New Password</label>
        <input type="password" id="editConfirmPassword" placeholder="Confirm new password">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" onclick="closeEditProfileModal()" style="background:#f3f3f3;padding:10px 16px;border-radius:8px;border:none;">Cancel</button>
        <button type="submit" style="background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;border:none;">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- SELL PANEL -->
<div id="sellPanel" class="sell-panel">
  <!-- Content will be dynamically inserted by JS -->
</div>

<!-- ITEM DETAIL MODAL -->
<div id="itemModal" class="modal">
  <div class="modal-content item-modal-content">
    <button class="modal-close" onclick="closeItemModal()">√ó</button>
    <div id="itemModalContent">
      <!-- Content will be populated by JS -->
    </div>
  </div>
</div>

<style>
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.open{display:flex}

.notifications-panel, .messages-panel{position:fixed;right:0;top:0;bottom:0;width:450px;background:white;color:#111;box-shadow:-25px 0 70px rgba(0,0,0,0.2);transform:translateX(100%);transition:transform .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);z-index:1100;padding:24px;overflow:auto;border-left:3px solid #1e8e3e}
.notifications-panel.open, .messages-panel.open{transform:translateX(0)}
.sell-panel{position:fixed;left:0;top:0;width:100vw;height:100vh;background:linear-gradient(180deg, #1fb04d 0%, #149140 100%);color:#111;transform:translateX(100%);transition:transform .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);z-index:1100;overflow:auto}
.sell-panel.open{transform:translateX(0)}
.panel-content{max-width:500px;margin:20px auto 0 auto;background:white;border-radius:12px;padding:24px;box-shadow:0 20px 40px rgba(0,0,0,0.15)}
.panel-close{position:absolute;left:12px;top:102px;border:none;background:#fff;color:#666;font-size:24px;cursor:pointer;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;transition:all .3s; box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:1200}
.panel-close:hover{background:#1e8e3e;color:#fff;transform:scale(1.1)}

.notifications-list{margin-top:20px}
.notification-item{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border-left:4px solid #1e8e3e;position:relative}
.notification-item.unread{background:#e7f6ec;border-left-color:#1e8e3e}
.notification-item .time{font-size:12px;color:#666;margin-top:8px}

.conversations-list{margin-top:20px}
.conversation-item{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;border-left:4px solid #1e8e3e;display:flex;align-items:center}
.conversation-item:hover{background:#f8f9fa}
.conversation-item img{width:50px;height:50px;border-radius:50%;margin-right:12px;object-fit:cover}
.conversation-item .info{flex:1}
.conversation-item .name{font-weight:700}
.conversation-item .last-msg{color:#666;font-size:14px;margin-top:4px}
.conversation-item .time{font-size:12px;color:#999}

.chat-view{margin-top:20px}
.chat-messages{max-height:400px;overflow:auto;margin-bottom:12px;padding:12px;background:#fff;border-radius:8px}
.message{display:flex;margin-bottom:8px}
.message.sent{justify-content:flex-end}
.message .bubble{background:#1e8e3e;color:#fff;padding:8px 12px;border-radius:18px;max-width:70%;word-wrap:break-word}
.message.received .bubble{background:#f1f1f1;color:#333}
.chat-input{display:flex;gap:8px}
.chat-input input{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
.chat-input button{background:#1e8e3e;color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer}
.chat-input button:hover{background:#149140}

/* Item Modal Styles */
.item-modal-content{max-width:900px;width:95%;max-height:90vh;overflow:auto;background:#fff;border-radius:16px;padding:0;box-shadow:0 20px 60px rgba(0,0,0,0.15);border:1px solid #e0e0e0}
.item-detail{display:flex;gap:30px;padding:30px;flex-wrap:wrap}
.item-image{flex:1;min-width:300px;max-width:400px;display:flex;justify-content:center;align-items:center;background:#f9f9f9;border-radius:12px;padding:20px;border:1px solid #ddd}
.item-image img{width:100%;height:auto;max-height:400px;object-fit:contain;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.item-info{flex:1;min-width:300px}
.item-info h2{margin:0 0 15px 0;font-size:32px;color:#222;font-weight:700;line-height:1.2}
.item-price{font-size:28px;font-weight:800;color:#1e8e3e;margin-bottom:15px;display:flex;align-items:center;gap:10px}
.item-price::before{content:'‚Ç±';font-size:24px}
.item-condition, .item-seller, .item-category{margin-bottom:10px;font-size:16px;color:#555;display:flex;align-items:center;gap:5px}
.item-condition::before{content:'üè∑Ô∏è';font-size:18px}
.item-seller::before{content:'üë§';font-size:18px}
.item-category::before{content:'üìÇ';font-size:18px}
.item-description{margin-top:25px;border-top:1px solid #eee;padding-top:20px}
.item-description h3{margin:0 0 15px 0;font-size:22px;color:#333;font-weight:600}
.item-description p{margin:0;font-size:16px;line-height:1.6;color:#666;text-align:justify}
.item-actions{margin-top:30px;display:flex;gap:15px;flex-wrap:wrap}
.item-actions button{padding:14px 24px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:0.5px}
.item-actions button:first-child{background:linear-gradient(135deg,#1e8e3e,#149140);color:#fff;box-shadow:0 4px 15px rgba(30,142,62,0.3)}
.item-actions button:first-child:hover{background:linear-gradient(135deg,#149140,#0d5930);transform:translateY(-2px);box-shadow:0 6px 20px rgba(30,142,62,0.4)}
.item-actions button:nth-child(2){background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;box-shadow:0 4px 15px rgba(245,158,11,0.3)}
.item-actions button:nth-child(2):hover{background:linear-gradient(135deg,#d97706,#b45309);transform:translateY(-2px);box-shadow:0 6px 20px rgba(245,158,11,0.4)}
.item-actions button:last-child{background:linear-gradient(135deg,#e5e7eb,#d1d5db);color:#333;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
.item-actions button:last-child:hover{background:linear-gradient(135deg,#d1d5db,#b3b6c6);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.15)}
</style>

</body>
</html>
