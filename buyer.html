<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESSU Marketplace</title>
  <link rel="stylesheet" href="buyer.css?v=20260218d">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Check authentication immediately -->
  <script>
  localStorage.setItem('essu_last_page', 'buyer.html');
  // Quick auth check before rendering
  let currentUser = null;
  try {
    currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  } catch {}
  if (currentUser?.role === 'admin') {
    window.location.href = "admin.html";
  } else if (!localStorage.getItem('buyer')) {
    window.location.href = "index.html";
  }
</script>

<!-- NAVBAR -->
<header class="navbar">
  <div class="nav-left">
    <h1>ESSU MARKETPLACE</h1>
  </div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search products..." oninput="searchProducts(this.value)">
  </div>

  <div class="nav-right">
    <button onclick="openNotificationsPanel()" style="position:relative;background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.93 6 11v5l-2 2v1h16v-1l-2-2z"/>
      </svg>
      <span id="notifBadge" class="badge"></span>
    </button>
    <button onclick="openMessagesPanel()" style="position:relative;background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
      </svg>
      <span id="msgBadge" class="badge"></span>
    </button>
    <button onclick="toggleProfile()" style="background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </button>
    <button onclick="openMiniCart()" style="position:relative;background:transparent;border:none;cursor:pointer" class="icon-btn">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
      </svg>
      <span id="cartBadge" class="badge"></span>
    </button>
  </div>
</header>

<!-- MAIN -->
<main class="container">

  <div class="title-row">
    <h2>Discover Items</h2>
  </div>

  <!-- CATEGORIES -->
  <div class="categories">
    <button class="cat active" onclick="setCategory('all')">All</button>
    <button class="cat" onclick="setCategory('electronics')">Electronics</button>
    <button class="cat" onclick="setCategory('books')">Books</button>
    <button class="cat" onclick="setCategory('clothing')">Clothing</button>
    <button class="cat" onclick="setCategory('furniture')">Furniture</button>
    <button class="cat" onclick="setCategory('sports')">Sports</button>
    <button class="cat" onclick="setCategory('food')">Food</button>
    <button class="cat" onclick="setCategory('other')">Other</button>
  </div>

  <div class="filters">
    <input type="number" id="minPrice" placeholder="Min">
    <input type="number" id="maxPrice" placeholder="Max">
    <select id="condition">
      <option value="All">All Conditions</option>
      <option value="New">New</option>
      <option value="Lightly Used">Lightly Used</option>
      <option value="Heavily Used">Heavily Used</option>
      <option value="Used">Used</option>
    </select>
    <select id="sort">
      <option value="latest">Latest</option>
      <option value="priceLow">Price: Low to High</option>
      <option value="priceHigh">Price: High to Low</option>
    </select>
  </div>



  <!-- PRODUCTS GRID (populated by app.js) -->
  <div class="grid" id="itemsGrid"></div>

</main>

<!-- FOOTER -->
<footer class="footer">
  <p>&copy; 2023 ESSU Marketplace. All rights reserved.</p>
</footer>



<!-- MINI CART PANEL -->
<div id="miniCart" class="mini-cart">
  <div class="mini-cart-content">
    <button class="mini-close" onclick="closeMiniCart()">&times;</button>
    <h4>Your Cart</h4>
    <div id="miniCartList" style="margin-top:8px;max-height:420px;overflow:auto"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="muted">Total</div>
      <div id="miniCartTotal" style="font-weight:800;color:var(--accent)"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="closeMiniCart()" style="flex:1;background:#f3f3f3;border:none;padding:10px;border-radius:8px">Continue Shopping</button>
      <button onclick="placeOrderFromMini()" style="flex:1;background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px">Checkout</button>
    </div>
  </div>
</div>

<!-- CHECKOUT MODAL (inline stepper) -->
<div id="checkoutModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeCheckoutModal()">&times;</button>
    <h3>Checkout</h3>

    <div id="step-login" class="hidden">
      <p class="muted">Please log in or sign up to place orders.</p>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button onclick="location.href='index.html'" style="padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff">Login</button>
        <button onclick="location.href='buyersignin.html'" style="padding:8px 12px;border-radius:8px;border:1px solid #eee;background:#fff">Sign up</button>
      </div>
    </div>

    <div id="step-payment" class="hidden">
      <p class="muted">Step 1 &mdash; Choose payment method</p>
      <div style="margin:12px 0">
        <label><input type="radio" name="pmethod" value="Cash on Delivery" checked> Cash on Delivery</label><br>
        <label style="color:#ccc;"><input type="radio" name="pmethod" value="GCash" disabled> GCash (Coming Soon)</label><br>
        <label style="color:#ccc;"><input type="radio" name="pmethod" value="PayMaya" disabled> PayMaya (Coming Soon)</label>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button onclick="closeCheckoutModal()" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Cancel</button>
        <button onclick="toAddressStep()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Continue</button>
      </div>
    </div>

    <div id="step-address" class="hidden">
      <p class="muted">Step 2 &mdash; Delivery address</p>
      <div class="address-form">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="addressName" placeholder="e.g. Juan Dela Cruz" class="address-input">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="addressPhone" placeholder="e.g. +63 912 345 6789 or 09123456789" class="address-input">
        </div>
        <div class="form-group">
          <label>City / Municipality</label>
          <input type="text" id="addressCity" placeholder="e.g. City of Borongan" class="address-input">
        </div>
        <div class="form-group">
          <label>CAMPUS</label>
          <select id="addressCampus" class="address-input">
            <option value="">Select Campus</option>
            <option value="Essu Arteche">Essu Arteche</option>
            <option value="Essu Can-Avid">Essu Can-Avid</option>
            <option value="Essu Borongan">Essu Borongan</option>
            <option value="Essu Maydolong">Essu Maydolong</option>
            <option value="Essu Guiuan">Essu Guiuan</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Department (Inside ESSU)</label>
          <select id="addressDepartment" class="address-input">
            <option value="">Select Department</option>
            <option value="College of Engineering">College of Engineering</option>
            <option value="College of Education">College of Education</option>
            <option value="College of Arts and Sciences">College of Arts and Sciences</option>
            <option value="College of Business and Management">College of Business and Management</option>
            <option value="College of Nursing">College of Nursing</option>
            <option value="College of Agriculture">College of Agriculture</option>
            <option value="College of Information Technology">College of Information Technology</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Additional Instructions (Optional)</label>
          <textarea id="addressNotes" placeholder="e.g. Leave at the guard house, ring the bell twice" class="address-textarea"></textarea>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button onclick="backToPaymentStep()" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Back</button>
        <button onclick="toReviewStep()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Continue</button>
      </div>
    </div>

    <div id="step-review" class="hidden">
      <p class="muted">Review & Confirm</p>
      <div id="checkoutItems" style="max-height:220px;overflow:auto;margin-bottom:10px"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="muted">Total</div>
        <div id="checkoutTotal" style="font-weight:800;color:var(--accent)"></div>
      </div>
      <div class="form-group">
        <label>Order Review (Optional)</label>
        <textarea id="orderReview" placeholder="Add any review or notes for your order..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;min-height:60px;"></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button onclick="backToAddressStep()" style="background:#f3f3f3;padding:8px 12px;border-radius:8px;border:none;">Back</button>
        <button onclick="confirmOrderFromModal()" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;">Confirm Order</button>
      </div>
    </div>

  </div>
</div>



<!-- PROFILE SIDEBAR -->
<div id="profileSidebar" class="profile-sidebar">
  <button class="close-btn" onclick="toggleProfile()">&times;</button>
  <div class="profile-header">
    <div class="avatar"></div>
    <h3></h3>
    <p id="sidebarEmail"></p>
  </div>
  <button class="sidebar-btn" onclick="openEditProfileModal()">Edit Profile</button>
  <button class="sidebar-btn" onclick="openSellPanel()">Start Selling</button>
  <button class="sidebar-btn danger" onclick="logout()">Sign Out</button>
  <div class="orders">
    <h4>My Orders</h4>
    <p id="sidebarName">Name: </p>
    <div id="sidebarOrders"></div>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay" onclick="toggleProfile()"></div>

<script src="runtime-config.js?v=20260217a"></script>
<script src="buyer.js?v=20260218a"></script>

<!-- NOTIFICATIONS PANEL -->
<div id="notificationsPanel" class="notifications-panel">
  <div class="panel-content">
    <button class="panel-close" onclick="closeNotificationsPanel()">&larr;</button>
    <h3>Notifications</h3>
    <div id="notificationsList" class="notifications-list"></div>
  </div>
</div>

<!-- MESSAGES PANEL -->
<div id="messagesPanel" class="messages-panel">
  <div class="panel-content messages-content">
    <button class="panel-close" onclick="closeMessagesPanel()">&larr;</button>
    <div class="messages-shell">
      <aside class="messages-sidebar">
        <div class="messages-title">Messages</div>
        <div class="messages-search">
          <input id="buyerMessageSearch" type="text" placeholder="Search conversations...">
        </div>
        <div id="conversationsList" class="conversations-list"></div>
      </aside>
      <section id="chatView" class="chat-view hidden">
        <div class="chat-header">
          <div class="chat-user">
            <span class="avatar" id="chatAvatar">--</span>
            <div>
              <div class="name" id="chatSellerName">Select a conversation</div>
              <div class="status" id="chatSellerStatus">Offline</div>
            </div>
          </div>
          <button class="icon-btn chat-menu" type="button" aria-label="More options">⋯</button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="messageInput" placeholder="Type a message...">
          <button class="send-btn" onclick="sendMessage()" aria-label="Send message">➤</button>
        </div>
        <button class="chat-back" onclick="backToConversations()">&larr; Back</button>
      </section>
    </div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div id="editProfileModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
    <h3>Edit Profile</h3>
    <form id="editProfileForm">
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="editName" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="editEmail" placeholder="Enter your email" readonly>
      </div>
      <div class="form-group">
        <label>Change Profile Photo</label>
        <input type="file" id="editPhoto" accept="image/*" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;">
      </div>
      <div class="form-group">
        <label>New Password (leave blank to keep current)</label>
        <input type="password" id="editPassword" placeholder="Enter new password">
      </div>
      <div class="form-group">
        <label>Confirm New Password</label>
        <input type="password" id="editConfirmPassword" placeholder="Confirm new password">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" onclick="closeEditProfileModal()" style="background:#f3f3f3;padding:10px 16px;border-radius:8px;border:none;">Cancel</button>
        <button type="submit" style="background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;border:none;">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- SELL PANEL -->
<div id="sellPanel" class="sell-panel">
  <!-- Content will be dynamically inserted by JS -->
</div>

<!-- ITEM DETAIL MODAL -->
<div id="itemModal" class="modal">
  <div class="modal-content item-modal-content">
    <button class="modal-close" onclick="closeItemModal()">&times;</button>
    <section class="product-detail" id="productDetailSection">
      <button class="back-btn" onclick="closeItemModal()" type="button">
        &larr; Back 
      </button>
      <div class="product-detail-layout">
        <div class="product-gallery">
          <img id="detailMainImage" class="detail-main" src="" alt="Product image">
          <div class="detail-thumbs" id="detailThumbs"></div>
        </div>
        <div class="product-info">
          <div class="detail-header">
            <span class="detail-tag" id="detailCategory">Category</span>
            <div class="detail-actions">
              <button class="icon-btn" onclick="event.stopPropagation(); toggleWishlist(this.dataset.productId); this.textContent = this.textContent === '\u2661' ? '\u2665' : '\u2661'; this.style.color = this.textContent === '\u2665' ? 'red' : '#333';" data-product-id="">&#9825;</button>
              <button class="icon-btn">&#8599;</button>
            </div>
          </div>
          <h2 id="detailTitle">Product Title</h2>
          <div class="detail-price" id="detailPrice">PHP 0</div>
          <div class="detail-meta">
            <span id="detailCondition">Condition: --</span>
            <span id="detailLocation">Location: --</span>
            <span id="detailPosted">Posted: --</span>
            <span id="detailViews">Views: --</span>
          </div>
          <div class="detail-desc">
            <h3>Description</h3>
            <p id="detailDescription">--</p>
          </div>
          <div class="detail-seller">
            <div>
              <strong id="detailSellerName">Seller</strong>
              <div class="detail-seller-role" id="detailSellerRole">Seller</div>
            </div>
            <div class="detail-rating">&#9733; 4.8 <span>(24 reviews)</span></div>
          </div>
          <button class="ghost-btn primary-btn" id="viewSellerProfileBtn">View Seller Profile</button>
          <button class="ghost-btn primary-btn" id="addToCartBtn">Add to Cart</button>
          <button class="primary-btn" id="contactSellerBtn">Message Seller</button>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- SELLER PROFILE MODAL -->
<div id="sellerProfileModal" class="modal">
  <div class="modal-content seller-profile-modal-content">
    <button class="modal-close" onclick="closeSellerProfileModal()">&times;</button>
    <div class="seller-profile-modal-header">
      <div class="seller-profile-avatar" id="sellerProfileAvatar">S</div>
      <div>
        <h3 id="sellerProfileName">Seller</h3>
        <p id="sellerProfileEmail">-</p>
      </div>
    </div>
    <div class="seller-profile-stats">
      <div><strong id="sellerProfileListingCount">0</strong><span>Listings</span></div>
      <div><strong id="sellerProfileActiveCount">0</strong><span>Active</span></div>
      <div><strong id="sellerProfileSoldCount">0</strong><span>Sold</span></div>
    </div>
    <h4>Seller Listings</h4>
    <div class="seller-profile-listings" id="sellerProfileListings"></div>
  </div>
</div>



</body>
</html>

